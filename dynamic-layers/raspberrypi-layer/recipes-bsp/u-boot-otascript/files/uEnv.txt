bootmmc=0:1
imgmmc=0:2

bootcmd_load_ostree_env=ext2load mmc ${imgmmc} $loadaddr /boot/loader/uEnv.txt; env import -t $loadaddr $filesize

bootcmd_args=setenv bootargs "$bootargs $bootargs_fdt ostree_root=/dev/mmcblk0p2 root=/dev/ram0 rw rootwait rootdelay=2 ramdisk_size=8192 panic=1"

load_kernel=ext2load mmc ${imgmmc} $kernel_addr_r "/boot"$kernel_image
load_ramdisk=ext2load mmc ${imgmmc} $ramdisk_addr_r "/boot"$ramdisk_image
bootcmd_load=run load_kernel; run load_ramdisk

bootcmd_run=bootm $kernel_addr_r $ramdisk_addr_r

bootcmd_boot=run bootcmd_args; run bootcmd_load; run bootcmd_run

bootcmd_stage_previous_os=if env exists bootargs2; then \
        setenv bootargs $bootargs2; \
        setenv kernel_image $kernel_image2; \
        setenv ramdisk_image $ramdisk_image2; \
    else \
        echo "No previous OS version found - exiting boot script and returning to bootloader"; \
        saveenv; \
        exit; \
    fi

bootcmd_reset_os_update_state=setenv os_update_activated; \
    setenv os_update_confirmed; \
    setenv os_update_reverted; \
    setenv os_update_boot_count 0

bootcmd=echo "Entering FotaHub boot script..."; \
    run bootcmd_load_ostree_env; \
    if env exists os_update_activated; then \
        if env exists os_update_confirmed; then \
            echo "OS update confirmed - booting normally..."; \
            run bootcmd_reset_os_update_state; \
        elif env exists os_update_reverted; then \
            echo "OS updated reverted - restoring previous OS version..."; \
            run bootcmd_reset_os_update_state; \
            run bootcmd_stage_previous_os; \
        else \
            if test $os_update_boot_count = 5; then \
                echo "Too many failed attempts to boot OS update - restoring previous OS version..."; \
                run bootcmd_reset_os_update_state; \
                run bootcmd_stage_previous_os; \
            else \
                if test $os_update_boot_count > 0; then \
                    echo "Previous attempt to boot OS update failed - retrying..."; \
                else \
                    echo "OS update activated, trying to boot it..."; \
                fi \
                setexpr os_update_boot_count $os_update_boot_count + 1; \
            fi \
        fi \
        saveenv; \
    else \
        echo "No OS update in progress - booting normally..."; \
        if test ! -e mmc ${bootmmc} uboot.env; then \
            run bootcmd_reset_os_update_state; \
            saveenv; \
        fi \
    fi \
    run bootcmd_boot
